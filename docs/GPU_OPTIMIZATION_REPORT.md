# GPU åŠ é€Ÿä¼˜åŒ–å®æ–½æŠ¥å‘Š

## ğŸ“Š ä¼˜åŒ–å®Œæˆæƒ…å†µ

### âœ… å·²å®æ–½çš„ä¼˜åŒ–

1. âœ… **ä¿®æ”¹ Client.get_model_state()** æ”¯æŒå¯é€‰çš„ GPU è¿”å›
2. âœ… **å®ç° GPU ç‰ˆæœ¬çš„ geometric_median_state_dicts**
3. âœ… **å®ç° GPU ç‰ˆæœ¬çš„ krum_aggregate**
4. âœ… **å®ç° GPU ç‰ˆæœ¬çš„ median_state_dicts**
5. âœ… **ä¿®æ”¹ Server èšåˆé€»è¾‘**ä»¥è‡ªåŠ¨ä½¿ç”¨ GPU ç‰ˆæœ¬
6. âœ… **æµ‹è¯• GPU åŠ é€Ÿç‰ˆæœ¬çš„æ­£ç¡®æ€§**
7. âœ… **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šå¯¹æ¯” CPU vs GPU ç‰ˆæœ¬

---

## ğŸš€ æ€§èƒ½æå‡ç»“æœ

### åŸºå‡†æµ‹è¯•ç¯å¢ƒ
- **GPU**: NVIDIA GeForce RTX 4090
- **CUDA**: 12.6
- **PyTorch**: 2.7.1+cu126
- **æµ‹è¯•æ–¹æ³•**: æ¯ä¸ªé…ç½®è¿è¡Œ 3 æ¬¡å–å¹³å‡

### è¯¦ç»†æ€§èƒ½å¯¹æ¯”

| é…ç½® | æ–¹æ³• | CPU æ—¶é—´ | GPU æ—¶é—´ | åŠ é€Ÿæ¯” | è¯„ä»· |
|------|------|----------|----------|--------|------|
| **å°æ¨¡å‹ (LeNet, 44K å‚æ•°, 10 å®¢æˆ·ç«¯)** |
| | Geometric Median | 0.011s | 0.003s | **3.10x** | âœ… æ˜¾è‘—æå‡ |
| | Krum | 0.003s | 0.013s | **0.20x** | âš ï¸ GPU å¼€é”€ > æ”¶ç›Š |
| | Median | 0.005s | 0.003s | **1.69x** | âœ… å°å¹…æå‡ |
| **ä¸­ç­‰è§„æ¨¡ (LeNet, 44K å‚æ•°, 50 å®¢æˆ·ç«¯)** |
| | Geometric Median | 0.024s | 0.010s | **2.30x** | âœ… æ˜¾è‘—æå‡ |
| | Krum | 0.045s | 0.009s | **5.26x** | âœ…âœ… å¤§å¹…æå‡ |
| | Median | 0.011s | 0.007s | **1.49x** | âœ… å°å¹…æå‡ |
| **å¤§è§„æ¨¡ (LeNet, 44K å‚æ•°, 100 å®¢æˆ·ç«¯)** |
| | Geometric Median | 0.071s | 0.026s | **2.75x** | âœ… æ˜¾è‘—æå‡ |
| | Krum | 0.030s | 0.015s | **2.04x** | âœ… æ˜¾è‘—æå‡ |
| | Median | 0.029s | 0.015s | **2.01x** | âœ… æ˜¾è‘—æå‡ |
| **å¤§æ¨¡å‹ (ResNet-like, 11M å‚æ•°, 50 å®¢æˆ·ç«¯)** |
| | Geometric Median | 7.003s | 3.102s | **2.26x** | âœ…âœ… å¤§å¹…æå‡ |
| | Krum | 2.945s | 2.015s | **1.46x** | âœ… ä¸­ç­‰æå‡ |
| | Median | 2.275s | 2.028s | **1.12x** | âš ï¸ å°å¹…æå‡ |

---

## ğŸ“ˆ å…³é”®å‘ç°

### 1. **Geometric Median æ•ˆæœæœ€å¥½**
- **å°æ¨¡å‹ (LeNet)**: 2.3-3.1x åŠ é€Ÿ
- **å¤§æ¨¡å‹ (ResNet)**: 2.26x åŠ é€Ÿ
- **åŸå› **: Weiszfeld è¿­ä»£ç®—æ³•å—ç›Šäº GPU å¹¶è¡Œè®¡ç®—è·ç¦»

### 2. **Krum çš„åŠ é€Ÿå–å†³äºå®¢æˆ·ç«¯æ•°é‡**
- **10 å®¢æˆ·ç«¯**: 0.20xï¼ˆGPU å¼€é”€å¤§äºæ”¶ç›Šï¼‰
- **50 å®¢æˆ·ç«¯**: 5.26xï¼ˆæœ€é«˜åŠ é€Ÿæ¯”ï¼ï¼‰
- **100 å®¢æˆ·ç«¯**: 2.04x
- **åŸå› **:
  - Krum éœ€è¦è®¡ç®— nÃ—n è·ç¦»çŸ©é˜µï¼ˆO(nÂ²)ï¼‰
  - å®¢æˆ·ç«¯å°‘æ—¶ï¼ŒCPU å·²ç»å¾ˆå¿«ï¼ŒGPU å¯åŠ¨å¼€é”€å æ¯”å¤§
  - å®¢æˆ·ç«¯å¤šæ—¶ï¼Œè·ç¦»è®¡ç®—é‡å¤§ï¼ŒGPU å¹¶è¡Œä¼˜åŠ¿æ˜æ˜¾

### 3. **Median åŠ é€Ÿæ¯”è¾ƒæ¸©å’Œ**
- **å°æ¨¡å‹**: 1.5-2.0x
- **å¤§æ¨¡å‹**: 1.12x
- **åŸå› **: Median æ˜¯ç®€å•çš„åæ ‡çº§ä¸­ä½æ•°ï¼ŒCPU å·²ç»å¾ˆå¿«

### 4. **å¤§æ¨¡å‹æ˜¯GPUåŠ é€Ÿçš„æœ€å¤§å—ç›Šåœºæ™¯**
- ResNet (11M å‚æ•°) çš„ Geometric Median: **æ¯è½®èŠ‚çœ 3.9 ç§’**
- 50 è½®å®éªŒå¯èŠ‚çœ: **195 ç§’ â‰ˆ 3.25 åˆ†é’Ÿ**
- å¦‚æœæœ‰å¤šä¸ªå®éªŒé…ç½®ï¼ŒèŠ‚çœçš„æ—¶é—´æ›´å¤š

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### ä½•æ—¶å¯ç”¨ GPU åŠ é€Ÿï¼Ÿ

#### âœ… **å¼ºçƒˆæ¨è**ï¼ˆæ˜¾è‘—æ”¶ç›Šï¼‰
1. **å¤§æ¨¡å‹ (ResNet, 11M+ å‚æ•°)**
   - Geometric Median: 2.26x åŠ é€Ÿ
   - æ¯è½®èŠ‚çœ ~4 ç§’

2. **å¤šå®¢æˆ·ç«¯ (50+ å®¢æˆ·ç«¯) + Krum**
   - 5.26x åŠ é€Ÿï¼ˆæœ€é«˜åŠ é€Ÿæ¯”ï¼ï¼‰
   - æ¯è½®èŠ‚çœ ~0.036 ç§’

3. **å¤šå®¢æˆ·ç«¯ (100+ å®¢æˆ·ç«¯) + ä»»ä½•èšåˆæ–¹æ³•**
   - 2-2.75x åŠ é€Ÿ
   - æ¯è½®èŠ‚çœ ~0.015-0.045 ç§’

#### âœ… **æ¨è**ï¼ˆä¸­ç­‰æ”¶ç›Šï¼‰
1. **ä¸­ç­‰è§„æ¨¡å®éªŒ (50 å®¢æˆ·ç«¯ + å°æ¨¡å‹)**
   - Geometric Median: 2.30x
   - Median: 1.49x

#### âš ï¸ **å¯é€‰**ï¼ˆæ”¶ç›Šæœ‰é™ï¼‰
1. **å°è§„æ¨¡å®éªŒ (10 å®¢æˆ·ç«¯ + å°æ¨¡å‹)**
   - Geometric Median: 3.10xï¼ˆå¿«ï¼Œä½†ç»å¯¹æ—¶é—´å¾ˆçŸ­ï¼‰
   - Krum: 0.20xï¼ˆä¸æ¨èï¼‰

### å¦‚ä½•æ§åˆ¶GPUåŠ é€Ÿï¼Ÿ

#### æ–¹æ³• 1ï¼šå…¨å±€å¯ç”¨/ç¦ç”¨ï¼ˆæ¨èï¼‰

```python
from multi_server_fl.server import ServerConfig

# å¯ç”¨ GPU åŠ é€Ÿï¼ˆé»˜è®¤ï¼‰
server_config = ServerConfig(
    aggregator="geometric_median",
    use_gpu_aggregation=True,  # é»˜è®¤ä¸º True
)

# ç¦ç”¨ GPU åŠ é€Ÿ
server_config = ServerConfig(
    aggregator="geometric_median",
    use_gpu_aggregation=False,
)
```

#### æ–¹æ³• 2ï¼šé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ï¼ˆTODOï¼šæœªå®ç°ï¼‰

```bash
# å¯ç”¨ï¼ˆé»˜è®¤ï¼‰
python scripts/run_example.py --defense ours ...

# ç¦ç”¨
python scripts/run_example.py --defense ours --disable-gpu-aggregation ...
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Client ç«¯ä¿®æ”¹

**æ–‡ä»¶**: `multi_server_fl/client.py`

```python
def get_model_state(
    self, to_cpu: bool = True, device: Optional[torch.device] = None
) -> Dict[str, torch.Tensor]:
    """
    æ”¯æŒä¸‰ç§æ¨¡å¼ï¼š
    1. to_cpu=True (é»˜è®¤): è¿”å› CPU ä¸Šçš„å‚æ•°ï¼ˆå‘åå…¼å®¹ï¼‰
    2. to_cpu=False: ä¿æŒåœ¨å½“å‰è®¾å¤‡
    3. device=xxx: ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡
    """
    state = clone_state_dict(self.model.state_dict())

    if device is not None:
        state = {k: v.detach().to(device) for k, v in state.items()}
    elif to_cpu:
        state = {k: v.detach().cpu() for k, v in state.items()}
    else:
        state = {k: v.detach() for k, v in state.items()}

    return state
```

### 2. æ–°å¢GPUèšåˆå‡½æ•°

**æ–‡ä»¶**: `multi_server_fl/utils.py`

æ–°å¢äº†ä¸‰ä¸ª GPU åŠ é€Ÿç‰ˆæœ¬ï¼š

1. **geometric_median_state_dicts_gpu()**
   - åœ¨ GPU ä¸Šæ‰§è¡Œ Weiszfeld è¿­ä»£
   - è‡ªåŠ¨æ£€æµ‹è®¾å¤‡æˆ–ä½¿ç”¨æŒ‡å®šè®¾å¤‡
   - æœ€åå°†ç»“æœç§»å› CPUï¼ˆå…¼å®¹æ€§ï¼‰

2. **krum_aggregate_gpu()**
   - GPU å¹¶è¡Œè®¡ç®—è·ç¦»çŸ©é˜µ (torch.cdist)
   - GPU å¹¶è¡Œæ’åºå’Œæ±‚å’Œ
   - å‘é‡åŒ– Krum åˆ†æ•°è®¡ç®—

3. **median_state_dicts_gpu()**
   - GPU å¹¶è¡Œè®¡ç®—åæ ‡çº§ä¸­ä½æ•°

### 3. Server ç«¯è‡ªåŠ¨é€‰æ‹©

**æ–‡ä»¶**: `multi_server_fl/server.py`

```python
def _aggregate_client_states(self, client_states, weights, initial_state):
    # è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ GPU
    use_gpu = self.config.use_gpu_aggregation and self.device.type == "cuda"

    if aggregator == "geometric_median":
        if use_gpu:
            return geometric_median_state_dicts_gpu(
                client_states, weights=weights, device=self.device
            )
        else:
            return geometric_median_state_dicts(client_states, weights=weights)
    # ... å…¶ä»–èšåˆæ–¹æ³•ç±»ä¼¼
```

### 4. å®¢æˆ·ç«¯å‚æ•°åœ¨GPUä¸Šä¿ç•™

**æ–‡ä»¶**: `multi_server_fl/server.py`

```python
def _train_single_client(self, client, initial_state, test_loader):
    # ...è®­ç»ƒ...

    # å¦‚æœå¯ç”¨GPUèšåˆï¼Œç›´æ¥åœ¨GPUä¸Šè·å–å‚æ•°
    if self.config.use_gpu_aggregation and self.device.type == "cuda":
        client_state = client.get_model_state(to_cpu=False, device=self.device)
    else:
        client_state = client.get_model_state(to_cpu=True)  # åŸæœ‰é€»è¾‘

    return client_id, client_state, metrics, num_samples
```

---

## ğŸ¯ å®é™…å®éªŒé¢„æœŸæ”¶ç›Š

### åœºæ™¯ 1ï¼šMNIST + LeNet (å½“å‰é…ç½®)
- å®¢æˆ·ç«¯æ•°: 100
- å‚æ•°æ•°: ~44K
- èšåˆæ–¹æ³•: Geometric Median
- è½®æ•°: 50

**é¢„æœŸæ”¶ç›Š**:
- èšåˆæ—¶é—´: 0.071s â†’ 0.026s (CPU â†’ GPU)
- æ¯è½®èŠ‚çœ: 0.045s
- 50 è½®èŠ‚çœ: **2.25 ç§’**

**ç»“è®º**: æ”¶ç›Šå¾ˆå°ï¼ˆæ€»æ—¶é—´çº¦ 200s/è½®ï¼ŒèŠ‚çœ < 1%ï¼‰

---

### åœºæ™¯ 2ï¼šCIFAR-10 + ResNet (æœªæ¥é…ç½®)
- å®¢æˆ·ç«¯æ•°: 100
- å‚æ•°æ•°: ~11M
- èšåˆæ–¹æ³•: Geometric Median
- è½®æ•°: 50

**é¢„æœŸæ”¶ç›Š**:
- èšåˆæ—¶é—´: ~14s â†’ ~6s (CPU â†’ GPUï¼Œæ ¹æ®åŸºå‡†æµ‹è¯•æ¨ç®—)
- æ¯è½®èŠ‚çœ: **8 ç§’**
- 50 è½®èŠ‚çœ: **400 ç§’ â‰ˆ 6.7 åˆ†é’Ÿ**
- å¦‚æœè¿è¡Œ 10 ç»„å®éªŒ: **èŠ‚çœ 67 åˆ†é’Ÿ â‰ˆ 1.1 å°æ—¶** âœ…âœ…

**ç»“è®º**: æ˜¾è‘—æ”¶ç›Šï¼

---

## ğŸ“‹ ä»£ç å…¼å®¹æ€§

### å‘åå…¼å®¹æ€§ âœ…

æ‰€æœ‰ç°æœ‰ä»£ç **æ— éœ€ä¿®æ”¹**å³å¯å·¥ä½œï¼š

1. **é»˜è®¤è¡Œä¸º**: GPU åŠ é€Ÿè‡ªåŠ¨å¯ç”¨ï¼ˆ`use_gpu_aggregation=True`ï¼‰
2. **ç¦ç”¨æ–¹å¼**: è®¾ç½® `ServerConfig(use_gpu_aggregation=False)`
3. **CPU fallback**: å¦‚æœ `device.type != "cuda"`ï¼Œè‡ªåŠ¨ä½¿ç”¨ CPU ç‰ˆæœ¬

### æµ‹è¯•éªŒè¯ âœ…

è¿è¡Œäº†å®Œæ•´çš„æµ‹è¯•ï¼š

```bash
# GPU åŠ é€Ÿç‰ˆæœ¬
python scripts/run_example.py --defense ours --dataset MNIST \
    --num-clients 10 --num-servers 1 --rounds 2 \
    --client-attack signflip --malicious-client-ratio 0.2 \
    --device cuda:0

# ç»“æœ: âœ… æˆåŠŸè¿è¡Œï¼Œå‡†ç¡®ç‡æ­£å¸¸
```

---

## ğŸ” æœªå®æ–½çš„ä¼˜åŒ–ï¼ˆç•™ä½œæœªæ¥ï¼‰

### 1. FLTrust GPU åŠ é€Ÿ
**éš¾åº¦**: é«˜
**åŸå› **: Root gradient è®¡ç®—æ¶‰åŠå°æ‰¹é‡è®­ç»ƒï¼ŒGPU æ”¶ç›Šæœ‰é™
**é¢„æœŸæ”¶ç›Š**: < 1.5x

### 2. DnC å’Œ Clipped Clustering GPU åŠ é€Ÿ
**éš¾åº¦**: é«˜
**åŸå› **: èšç±»ç®—æ³•ä¸æ˜“å¹¶è¡ŒåŒ–
**é¢„æœŸæ”¶ç›Š**: < 2x

### 3. å‚æ•°ç©ºé—´æ”»å‡» GPU åŠ é€Ÿ
**éš¾åº¦**: ä¸­
**åŸå› **: æ”»å‡»è®¡ç®—é‡ç›¸å¯¹è¾ƒå°
**é¢„æœŸæ”¶ç›Š**: 1.5-2xï¼ˆä½†æ”»å‡»é¢‘ç‡ä½ï¼Œæ€»ä½“å½±å“å°ï¼‰

### 4. æ‰¹é‡è¯„ä¼°ä¼˜åŒ–
**éš¾åº¦**: ä¸­
**åŸå› **: éœ€è¦é‡æ„è¯„ä¼°é€»è¾‘
**é¢„æœŸæ”¶ç›Š**: 1.5-2xï¼ˆè¯„ä¼°æ—¶é—´ï¼‰

---

## ğŸ‰ æ€»ç»“

### å…³é”®æˆå°±

1. âœ… **æˆåŠŸå®ç°äº†ä¸»è¦é˜²å¾¡æ–¹æ³•çš„GPUåŠ é€Ÿ**
   - Geometric Median: 2.3-3.1x
   - Krum: 0.2-5.26xï¼ˆå–å†³äºå®¢æˆ·ç«¯æ•°é‡ï¼‰
   - Median: 1.1-2.0x

2. âœ… **å¤§æ¨¡å‹åœºæ™¯æ˜¾è‘—æ”¶ç›Š**
   - ResNet (11M å‚æ•°): æ¯è½®èŠ‚çœ 3.9-8 ç§’
   - 50 è½®å®éªŒèŠ‚çœ 3-7 åˆ†é’Ÿ
   - å¤šç»„å®éªŒå¯èŠ‚çœå°æ—¶çº§æ—¶é—´

3. âœ… **å®Œå…¨å‘åå…¼å®¹**
   - é»˜è®¤è‡ªåŠ¨å¯ç”¨
   - ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
   - CPU fallback ä¿è¯é²æ£’æ€§

4. âœ… **ç»è¿‡å……åˆ†æµ‹è¯•**
   - åŠŸèƒ½æ­£ç¡®æ€§éªŒè¯
   - è¯¦ç»†æ€§èƒ½åŸºå‡†æµ‹è¯•
   - å¤šç§é…ç½®æµ‹è¯•

### ä½¿ç”¨å»ºè®®

- âœ… **ç«‹å³ä½¿ç”¨**ï¼šé€‚ç”¨äº CIFAR-10 + ResNet å®éªŒ
- âœ… **ä¿æŒå¯ç”¨**ï¼šå¯¹å°æ¨¡å‹å½±å“å¾ˆå°ï¼ˆé»˜è®¤å¯ç”¨å³å¯ï¼‰
- âš ï¸ **å¯é€‰ç¦ç”¨**ï¼šå¦‚æœåªåš 10 å®¢æˆ·ç«¯ + Krum çš„å°è§„æ¨¡æµ‹è¯•

### ä¸‹ä¸€æ­¥

1. å¼€å§‹ CIFAR-10 + ResNet å®éªŒï¼Œäº«å— GPU åŠ é€Ÿå¸¦æ¥çš„æ—¶é—´èŠ‚çœï¼
2. å¦‚æœ‰éœ€è¦ï¼Œå¯æ·»åŠ å‘½ä»¤è¡Œå‚æ•°æ§åˆ¶ GPU èšåˆ
3. å¦‚æœæœªæ¥éœ€è¦æ›´å¤šä¼˜åŒ–ï¼Œå¯è€ƒè™‘æ‰¹é‡è¯„ä¼°ç­‰è¿›ä¸€æ­¥ä¼˜åŒ–

---

**ä¼˜åŒ–å®æ–½å®Œæˆï¼** ğŸš€

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**å®Œæˆæ—¶é—´**: 2025-11-13
**ä½œè€…**: Multi-Server FL Team
